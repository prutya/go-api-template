services:
  dbmate:
    image: docker.io/amacneil/dbmate:2.21.0
    environment:
      DATABASE_URL: postgres://app_username:app_password@postgres:5432/app_database?sslmode=disable
    volumes:
      - ./db:/db
    networks:
      - app_dev
    depends_on:
      postgres:
        condition: service_healthy
  postgres:
    image: docker.io/bitnami/postgresql:16.4.0-debian-12-r9
    environment:
      POSTGRESQL_USERNAME: app_username
      POSTGRESQL_PASSWORD: app_password
      POSTGRESQL_DATABASE: app_database
    ports:
      - 5432:5432
    volumes:
      - postgres_data:/bitnami/postgresql
    networks:
      - app_dev
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d app_database"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data: {}

networks:
  app_dev: {}
